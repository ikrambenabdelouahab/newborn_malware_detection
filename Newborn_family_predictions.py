import pickle, numpy

# import new malware family features
new_malware = numpy.load('Newborn_features/features.npy')
no_imgs = numpy.load('Newborn_features/no_imgs.npy')
total = no_imgs[0] + no_imgs[1]
y = numpy.load('Newborn_features/labels.npy')
newborn = numpy.load('Newborn_features/list_fams.npy')

# Load malware families name list
list_fams = numpy.load('Train_features/list_fams.npy')

# Define function to convert any label to its family name
def from_label_to_family_name(given_label):
    for i in range(len(list_fams)):
        if i == given_label :
            return list_fams[i]
    return 'Sorry, Label not found !!'

# Load trained model
knn = pickle.load(open("trained_models/knn.sav", "rb"))

output = []

import csv
row_list = [["ID" , "Family" , "Proba", "Real Family"]]
with open('result.csv', 'w') as file:
    writer = csv.writer(file, quoting=csv.QUOTE_NONNUMERIC, delimiter=';')

    for i in range(total):
        input = new_malware[i]
        result_knn = knn.predict_proba(input)
        real_label = y[i]
        for j in range(23):
            if result_knn[0][j] != 0:
                row_list.append([i, from_label_to_family_name(j) , result_knn[0][j], real_label])
    writer.writerows(row_list)